package vn.edu.app.server.service;

import vn.edu.app.common.dto.UserDTO;
import vn.edu.app.common.remote.AuthService;
import vn.edu.app.server.dao.UserDAO;

import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;
import java.util.Optional;

public class AuthServiceImpl extends UnicastRemoteObject implements AuthService {
    private final UserDAO userDAO;

    public AuthServiceImpl(UserDAO userDAO) throws RemoteException {
        super();
        this.userDAO = userDAO;
    }

    @Override
    public UserDTO login(String username, String password) throws RemoteException {
        Optional<UserDAO.UserRecord> opt = userDAO.findByUsername(username);
        if (opt.isEmpty()) return null;
        var u = opt.get();

        // So sánh mật khẩu trực tiếp (plaintext)
        if (password.equals(u.password)) {
            return new UserDTO(u.username, u.role, u.studentIdOrNull);
        }
        return null;
    }

    @Override
    public boolean changePassword(String username, String oldPass, String newPass) throws RemoteException {
        Optional<UserDAO.UserRecord> opt = userDAO.findByUsername(username);
        if (opt.isEmpty()) return false;
        var u = opt.get();

        if (!oldPass.equals(u.password)) return false;

        return userDAO.updatePassword(username, newPass);
    }
}
