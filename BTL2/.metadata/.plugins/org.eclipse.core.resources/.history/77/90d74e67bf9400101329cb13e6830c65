package vn.edu.app.client.ui;

import vn.edu.app.client.remote.RMIConnector;
import vn.edu.app.client.util.UIUtils;
import vn.edu.app.common.dto.UserDTO;
import vn.edu.app.common.remote.AuthService;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;

public class LoginFrame extends JFrame {
    private JTextField tfUsername = new JTextField(20);
    private JPasswordField tfPassword = new JPasswordField(20);

    public LoginFrame() {
        setTitle("Student Management - Login");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setSize(400, 280);
        setResizable(false);
        setLocationRelativeTo(null);

        // Root panel
        JPanel root = new JPanel(new BorderLayout(10,10));
        root.setBorder(BorderFactory.createEmptyBorder(20,20,20,20));
        root.setBackground(Color.WHITE);

        // Title
        JLabel lblTitle = new JLabel("User Login", SwingConstants.CENTER);
        lblTitle.setFont(new Font("Segoe UI", Font.BOLD, 20));
        lblTitle.setForeground(new Color(50,50,50));
        root.add(lblTitle, BorderLayout.NORTH);

        // Form
        JPanel form = new JPanel(new GridBagLayout());
        form.setOpaque(false);
        GridBagConstraints g = new GridBagConstraints();
        g.insets = new Insets(10,5,10,5);
        g.fill = GridBagConstraints.HORIZONTAL;

        // Username
        g.gridx=0; g.gridy=0;
        form.add(new JLabel(UIUtils.icon("icons/user.png", 20, 20)), g);
        g.gridx=1; form.add(tfUsername, g);

        // Password
        g.gridx=0; g.gridy=1;
        form.add(new JLabel(UIUtils.icon("icons/password.png", 20, 20)), g);
        g.gridx=1; form.add(tfPassword, g);

        root.add(form, BorderLayout.CENTER);

        // Action buttons
        JPanel actions = new JPanel(new FlowLayout(FlowLayout.CENTER));
        actions.setOpaque(false);

        JButton btnLogin = new JButton("Login");
        btnLogin.setBackground(new Color(76, 175, 80)); // xanh lá
        btnLogin.setForeground(Color.WHITE);
        btnLogin.setFocusPainted(false);
        btnLogin.setFont(new Font("Segoe UI", Font.BOLD, 16));
        btnLogin.setPreferredSize(new Dimension(120, 36));

        JButton btnExit = new JButton("Exit");
        btnExit.setBackground(new Color(220, 53, 69)); // đỏ
        btnExit.setForeground(Color.WHITE);
        btnExit.setFocusPainted(false);
        btnExit.setFont(new Font("Segoe UI", Font.BOLD, 16));
        btnExit.setPreferredSize(new Dimension(120, 36));

        actions.add(btnLogin);
        actions.add(btnExit);

        root.add(actions, BorderLayout.SOUTH);

        setContentPane(root);

        // Events
        btnLogin.addActionListener(this::doLogin);
        btnExit.addActionListener(e -> System.exit(0));
        getRootPane().setDefaultButton(btnLogin);
    }

    private void doLogin(ActionEvent e) {
        try {
            AuthService auth = RMIConnector.auth();
            String u = tfUsername.getText().trim();
            String p = new String(tfPassword.getPassword());
            if (u.isEmpty() || p.isEmpty()) {
                UIUtils.error(this, "Please enter username & password");
                return;
            }

            UserDTO user = auth.login(u,p);
            if (user != null) {
                UIUtils.info(this, "Welcome " + user.getUsername());
                new MainFrame(user).setVisible(true);
                dispose();
            } else {
                UIUtils.error(this, "Invalid username or password");
            }
        } catch (Exception ex) {
            ex.printStackTrace();
            UIUtils.error(this, "Connection error: " + ex.getMessage());
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new LoginFrame().setVisible(true));
    }
}
